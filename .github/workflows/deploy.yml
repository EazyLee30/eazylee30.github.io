name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Replace API Key
        run: |
          echo "=== API Key Replacement Step ==="
          echo "Checking for GEMINI_API_KEY secret..."
          
          # Debug: Check if secret is accessible (without exposing it)
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "ERROR: GEMINI_API_KEY secret is empty or not accessible!"
            echo "Please verify:"
            echo "1. Secret name is exactly 'GEMINI_API_KEY' (case-sensitive)"
            echo "2. Secret is set in: Settings > Secrets and variables > Actions"
            echo "3. Secret has the correct value"
            exit 1
          fi
          
          echo "Secret found (length: ${#GEMINI_API_KEY} characters)"
          
          # Check file exists
          if [ ! -f "game/gomoku/index.html" ]; then
            echo "ERROR: game/gomoku/index.html not found!"
            echo "Current directory: $(pwd)"
            echo "Files in game/: $(ls -la game/ 2>&1 || echo 'game/ not found')"
            exit 1
          fi
          
          echo "File found. Current file size: $(wc -c < game/gomoku/index.html) bytes"
          
          # Show before replacement
          echo "Before replacement:"
          BEFORE=$(grep "const GEMINI_API_KEY" game/gomoku/index.html | head -1)
          echo "$BEFORE"
          
          # Use perl for replacement - escape the placeholder properly
          API_KEY="${{ secrets.GEMINI_API_KEY }}"
          echo "Attempting replacement with perl..."
          
          # Try multiple replacement patterns
          # Method 1: Use Python (most reliable for string replacement)
          python3 << EOF
import sys
api_key = "$API_KEY"
with open('game/gomoku/index.html', 'r', encoding='utf-8') as f:
    content = f.read()
    
original = "const GEMINI_API_KEY = '{{GEMINI_API_KEY}}';"
replacement = f"const GEMINI_API_KEY = '{api_key}';"

if original in content:
    content = content.replace(original, replacement)
    with open('game/gomoku/index.html', 'w', encoding='utf-8') as f:
        f.write(content)
    print("Python replacement: SUCCESS")
    sys.exit(0)
else:
    print("Python replacement: Pattern not found")
    sys.exit(1)
EOF
          if [ $? -ne 0 ]; then
            echo "Python replacement failed, trying perl..."
            # Method 2: Use perl
            perl -i -pe "s|const GEMINI_API_KEY = '\{\{GEMINI_API_KEY\}\}';|const GEMINI_API_KEY = '$API_KEY';|g" game/gomoku/index.html
            if [ $? -ne 0 ]; then
              echo "Perl replacement failed, trying sed..."
              # Method 3: Use sed
              sed -i.bak "s|const GEMINI_API_KEY = '{{GEMINI_API_KEY}}';|const GEMINI_API_KEY = '$API_KEY';|g" game/gomoku/index.html
              rm -f game/gomoku/index.html.bak
            fi
          fi
          
          echo "After replacement:"
          AFTER=$(grep "const GEMINI_API_KEY" game/gomoku/index.html | head -1)
          echo "$AFTER"
          
          # Verify replacement
          if echo "$AFTER" | grep -q "{{GEMINI_API_KEY}}"; then
            echo "ERROR: Replacement failed! Placeholder still exists."
            echo "Final attempt with direct Python replacement..."
            python3 << EOF
api_key = "$API_KEY"
with open('game/gomoku/index.html', 'r', encoding='utf-8') as f:
    content = f.read()
content = content.replace("const GEMINI_API_KEY = '{{GEMINI_API_KEY}}';", f"const GEMINI_API_KEY = '{api_key}';")
with open('game/gomoku/index.html', 'w', encoding='utf-8') as f:
    f.write(content)
EOF
            AFTER=$(grep "const GEMINI_API_KEY" game/gomoku/index.html | head -1)
            if echo "$AFTER" | grep -q "{{GEMINI_API_KEY}}"; then
              echo "ERROR: All replacement methods failed!"
              echo "Final check - file content around API key:"
              grep -A 2 -B 2 "GEMINI_API_KEY" game/gomoku/index.html | head -10
              exit 1
            fi
          fi
          
          # Final verification
          if echo "$AFTER" | grep -q "const GEMINI_API_KEY = 'AIza"; then
            echo "SUCCESS: API Key replaced successfully!"
            echo "Verified: API Key starts with 'AIza'"
          else
            echo "WARNING: API Key format verification failed"
            echo "Replaced line: $AFTER"
            # Don't fail, but warn
          fi
      
      - name: Verify files before upload
        run: |
          echo "Verifying game/gomoku/index.html exists and contains replaced key..."
          if [ ! -f "game/gomoku/index.html" ]; then
            echo "ERROR: File missing!"
            exit 1
          fi
          if grep -q "{{GEMINI_API_KEY}}" game/gomoku/index.html; then
            echo "ERROR: Placeholder still exists in file!"
            exit 1
          fi
          echo "File verified successfully"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

