name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Replace API Key
        run: |
          echo "=== API Key Replacement Step ==="
          echo "Checking for GEMINI_API_KEY secret..."
          
          # Debug: Check if secret is accessible (without exposing it)
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "ERROR: GEMINI_API_KEY secret is empty or not accessible!"
            echo "Please verify:"
            echo "1. Secret name is exactly 'GEMINI_API_KEY' (case-sensitive)"
            echo "2. Secret is set in: Settings > Secrets and variables > Actions"
            echo "3. Secret has the correct value"
            exit 1
          fi
          
          echo "Secret found (length: ${#GEMINI_API_KEY} characters)"
          
          # Check file exists
          if [ ! -f "game/gomoku/index.html" ]; then
            echo "ERROR: game/gomoku/index.html not found!"
            echo "Current directory: $(pwd)"
            echo "Files in game/: $(ls -la game/ 2>&1 || echo 'game/ not found')"
            exit 1
          fi
          
          echo "File found. Current file size: $(wc -c < game/gomoku/index.html) bytes"
          
          # Show before replacement
          echo "Before replacement:"
          BEFORE=$(grep "const GEMINI_API_KEY" game/gomoku/index.html | head -1)
          echo "$BEFORE"
          
          # Use Python for replacement (handles special characters safely)
          API_KEY="${{ secrets.GEMINI_API_KEY }}"
          export API_KEY
          echo "Attempting replacement with Python..."
          
          # Create Python script using echo to avoid YAML heredoc issues
          echo 'import os' > /tmp/replace_key.py
          echo 'import sys' >> /tmp/replace_key.py
          echo "api_key = os.environ.get('API_KEY', '')" >> /tmp/replace_key.py
          echo 'if not api_key:' >> /tmp/replace_key.py
          echo "    print('ERROR: API_KEY not set')" >> /tmp/replace_key.py
          echo '    sys.exit(1)' >> /tmp/replace_key.py
          echo '' >> /tmp/replace_key.py
          echo "with open('game/gomoku/index.html', 'r', encoding='utf-8') as f:" >> /tmp/replace_key.py
          echo '    content = f.read()' >> /tmp/replace_key.py
          echo '' >> /tmp/replace_key.py
          echo 'original = "const GEMINI_API_KEY = '\''{{GEMINI_API_KEY}}'\'';"' >> /tmp/replace_key.py
          echo "replacement = f\"const GEMINI_API_KEY = '{api_key}';\"" >> /tmp/replace_key.py
          echo '' >> /tmp/replace_key.py
          echo 'if original in content:' >> /tmp/replace_key.py
          echo '    content = content.replace(original, replacement)' >> /tmp/replace_key.py
          echo "    with open('game/gomoku/index.html', 'w', encoding='utf-8') as f:" >> /tmp/replace_key.py
          echo '        f.write(content)' >> /tmp/replace_key.py
          echo "    print('Python replacement: SUCCESS')" >> /tmp/replace_key.py
          echo '    sys.exit(0)' >> /tmp/replace_key.py
          echo 'else:' >> /tmp/replace_key.py
          echo "    print('ERROR: Pattern not found in file')" >> /tmp/replace_key.py
          echo '    sys.exit(1)' >> /tmp/replace_key.py
          
          python3 /tmp/replace_key.py
          
          # Verify replacement worked
          if [ $? -eq 0 ]; then
            echo "Python replacement: SUCCESS"
          else
            echo "Python replacement: FAILED"
            exit 1
          fi
          
          echo "After replacement:"
          AFTER=$(grep "const GEMINI_API_KEY" game/gomoku/index.html | head -1)
          echo "$AFTER"
          
          # Verify replacement
          if echo "$AFTER" | grep -q "{{GEMINI_API_KEY}}"; then
            echo "ERROR: Replacement failed! Placeholder still exists."
            echo "Final check - file content around API key:"
            grep -A 2 -B 2 "GEMINI_API_KEY" game/gomoku/index.html | head -10
            exit 1
          fi
          
          # Final verification
          if echo "$AFTER" | grep -q "const GEMINI_API_KEY = 'AIza"; then
            echo "SUCCESS: API Key replaced successfully!"
            echo "Verified: API Key starts with 'AIza'"
          else
            echo "WARNING: API Key format verification failed"
            echo "Replaced line: $AFTER"
            # Don't fail, but warn
          fi
      
      - name: Verify files before upload
        run: |
          echo "Verifying game/gomoku/index.html exists and contains replaced key..."
          if [ ! -f "game/gomoku/index.html" ]; then
            echo "ERROR: File missing!"
            exit 1
          fi
          if grep -q "{{GEMINI_API_KEY}}" game/gomoku/index.html; then
            echo "ERROR: Placeholder still exists in file!"
            exit 1
          fi
          echo "File verified successfully"
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

